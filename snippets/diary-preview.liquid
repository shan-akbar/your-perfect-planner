{% assign diary_pages = product.metafields.custom.diary_pages.value %}

{%- paginate diary_pages by 128 -%}

    {% assign diary_pages = diary_pages | reverse | reverse %}
    <script>
        let diary_pages = [];
        {% for diary_page in diary_pages %}
            {% assign page_type = 'day' %}
            {% if forloop.first or forloop.last %}
                {% assign page_type = 'outer_cover' %}
            {% endif %}
            diary_pages.push({page_type: {{ page_type | json }}, page_url: {{ diary_page |  image_url: width: diary_page.width | json }}});
        {% endfor %}
    </script>
{%- endpaginate -%}

<div class="diary-wrapper">
  
  <div class="diary-flip">

        {% for index in (1..370) %}
            
                
        <div class="diary-flip_page diary-flip_page__{{index}} {% if index > 2 %}display__none{% endif %}" style="z-index: {{ 370 | minus: index }};" data-pageindex="{{index}}"> 
                    <div class="diary-flip_back">
                        <img src="https://cdn.shopify.com/s/files/1/0870/1021/4194/files/blank-page.jpg?v=1716241450" class="back-page">
                        <label class="diary-flip_back-btn">Prev</label>
                    </div>
                    <div class="diary-flip_front">
                        <img src="{{ diary_pages[0] | image_url: width: diary_pages[0].width }}" class="front-page">
                        <label class="diary-flip_next-btn">NEXT</label>
                    </div>
        </div>
                
        {% endfor %}
       
  </div>

</div>


<script>

    function movePointer(index){
        let pages_preview = document.querySelectorAll(".diary-flip_page");
        let preview_pages_length = pages_preview.length;
        for(var i=0;i<preview_pages_length;++i){
            let page = pages_preview[i];
            if(i<index){
                
            }else{

            }
        }
    }
   
    function renderPages(){
        if(diary_pages.length % 2 != 0){
            diary_pages.splice(diary_pages.length-1, 0, {page_type:"blank", page_url:"https://cdn.shopify.com/s/files/1/0870/1021/4194/files/blank-page.jpg?v=1716241450" });
        }
        let old_last_page = document.querySelector(".diary-flip_page.last__page");
        old_last_page?.classList.remove('last__page');
        let old_second_last_page = document.querySelector(".diary-flip_page.second_last__page");
        old_second_last_page?.classList.remove('second_last__page');
        let pages_preview = document.querySelectorAll(".diary-flip_page");
        let pages_length = diary_pages.length/2;
        let last_page = pages_preview[pages_length - 1];
        let second_last_page = pages_preview[pages_length - 2];
        last_page.classList.add("last__page");
        second_last_page.classList.add("second_last__page");
        let side_index = 0;
        let run_pointer_fix = true;
        for(var i=0;i<pages_length;++i){
            let page = pages_preview[i];
            page.querySelector(".front-page").setAttribute("src", diary_pages[side_index].page_url);
            page.querySelector(".back-page").setAttribute("src", diary_pages[side_index + 1].page_url);
            side_index += 2;
            if(page.classList.contains("flipped") && !page.classList.contains("display__none") && run_pointer_fix){
                run_pointer_fix = false;
                let next_page = pages_preview[i+1];
                if(next_page){
                    next_page.classList.remove('display__none');
                }
                
                let after_next_page = pages_preview[i+2];
                if(after_next_page){
                    after_next_page.classList.remove('display__none');
                    if(after_next_page.classList.contains('flipped')){
                        after_next_page.classList.remove('flipped');
                        let current_zindex = after_next_page.style.zIndex;
                        after_next_page.style.zIndex = 370-Number(current_zindex);
                    }
                    
                }

                let after_after_next_page = pages_preview[i+3];
                if(after_after_next_page){
                    after_after_next_page.classList.remove('display__none');
                    if(after_after_next_page.classList.contains('flipped')){
                        after_after_next_page.classList.remove('flipped');
                        let current_zindex = after_after_next_page.style.zIndex;
                        after_after_next_page.style.zIndex =  370-Number(current_zindex);
                    }
                }
            }
        }

        let preview_pages_length = pages_preview.length;
        let reverse_fix = false;
        for(var i=pages_length;i<preview_pages_length;++i){
            let page = pages_preview[i];
           
            page.classList.add('display__none');
            if(page.classList.contains("flipped")){
                reverse_fix = true;
                page.classList.remove("flipped");
                let current_zindex = page.style.zIndex;
                page.style.zIndex =  370-Number(current_zindex);
            }
        }

        if(reverse_fix){
            last_page.classList.remove('display__none');
            if(last_page.classList.contains('flipped')){
                last_page.classList.remove('flipped');
                let current_zindex = last_page.style.zIndex;
                last_page.style.zIndex =  370-Number(current_zindex);
            }
            if(!second_last_page.classList.contains('flipped')){
                second_last_page.classList.add('flipped');
                let current_zindex = second_last_page.style.zIndex;
                second_last_page.style.zIndex =  370-Number(current_zindex);
            }
            second_last_page.classList.remove('display__none');
            let third_last_page = pages_preview[pages_length - 3];
            if(!third_last_page.classList.contains('flipped')){
                third_last_page.classList.add('flipped');
                let current_zindex = third_last_page.style.zIndex;
                third_last_page.style.zIndex =  370-Number(current_zindex);
            }
            third_last_page.classList.remove('display__none');
        }

    }
    

    renderPages();

    function extraPages(){
        let page_type = this.event.target.closest(".planner-custom-pages_wrapper").getAttribute("data-pagetype");

        if(page_type == "front_cover"){
            frontCoverPages(this.event.target);
        }
        
        if(page_type == "between_week"){
            inBetweenWeekPages(this.event.target);
        }

        if(page_type == "between_month"){
            inBetweenMonthPages(this.event.target);
        }

        if(page_type == "back_cover"){
            backCoverPages(this.event.target);
        }
    }

    function frontCoverPages(element){
        let image_front = element.closest(".page_item").querySelector(".extra-image").getAttribute("src");
        let image_back = element.closest(".page_item").querySelector(".preview-icon").getAttribute("data-backimage");
        let pages_length = diary_pages.length;
        let updated_pages = [];
        let cover_added = false;
        if(element.checked){
            for(var i=0;i<pages_length;++i){
                if(diary_pages[i].page_type != "outer_cover" && diary_pages[i].page_type != "inner_cover" && !cover_added){
                    cover_added = true;
                    updated_pages.push({page_type: "inner_cover", page_url: image_front });
                    if(image_back){
                        updated_pages.push({page_type: "inner_cover", page_url: image_back });
                    }
                }

                if(diary_pages[i].page_type != "blank"){
                    updated_pages.push(diary_pages[i]);
                }

            }
        }else{
            for(var i=0;i<pages_length;++i){
                if((diary_pages[i].page_url == image_front || diary_pages[i].page_url == image_back)&& diary_pages[i].page_type == 'inner_cover'){
                    continue;
                }else{
                    
                    if(diary_pages[i].page_type != "blank"){
                        updated_pages.push(diary_pages[i]);
                    }
                }
            
            }
        }

        diary_pages = updated_pages;
        renderPages();
    }

    function inBetweenWeekPages(element){
        let image_front = element.closest(".page_item").querySelector(".extra-image").getAttribute("src");
        let image_back = element.closest(".page_item").querySelector(".preview-icon").getAttribute("data-backimage");
        let pages_length = diary_pages.length;
        let updated_pages = [];
        if(element.checked){
            // for 2025 year starts at Wednesday so starting day number is 2
            let day_page_counter = 2; 
            for(var i=0;i<pages_length;++i){
                if(day_page_counter == 7 && diary_pages[i].page_type != "week"){
                    updated_pages.push({page_type: "week", page_url: image_front });
                    if(image_back){
                        updated_pages.push({page_type: "week", page_url: image_back });
                    }
                    day_page_counter = 0;
                }

                if(diary_pages[i].page_type != "blank"){
                    updated_pages.push(diary_pages[i]);
                }

                if(diary_pages[i].page_type == 'day'){
                    ++day_page_counter;
                }
            }
           
        }else{
            for(var i=0;i<pages_length;++i){
                if((diary_pages[i].page_url == image_front || diary_pages[i].page_url == image_back)&& diary_pages[i].page_type == 'week'){
                    continue;
                }else{
                    if(diary_pages[i].page_type != "blank"){
                        updated_pages.push(diary_pages[i]);
                    }
                }
            
            }
        }
        diary_pages = updated_pages;
        renderPages();
    }

    function daysInMonth(month, year) {
        return new Date(year, month, 0).getDate();
    }

    function inBetweenMonthPages(element){
        let image_front = element.closest(".page_item").querySelector(".extra-image").getAttribute("src");
        let image_back = element.closest(".page_item").querySelector(".preview-icon").getAttribute("data-backimage");
        let pages_length = diary_pages.length;
        let updated_pages = [];
        if(element.checked){
            let current_month = 1;
            let day_counter = 0;
            let days_in_current_month = daysInMonth(current_month, 2025);
            for(var i=0;i<pages_length;++i){
                
                if(day_counter == days_in_current_month){
                    if(diary_pages[i].page_type != "week" && diary_pages[i].page_type != "month"){
                        updated_pages.push({page_type: "month", page_url: image_front });
                        if(image_back){
                            updated_pages.push({page_type: "month", page_url: image_back });
                        }
                        
                        ++current_month
                        days_in_current_month = daysInMonth(current_month, 2025);
                        day_counter = 0
                    }
                }

                if(diary_pages[i].page_type != "blank"){
                    updated_pages.push(diary_pages[i]);
                }

                if(diary_pages[i].page_type == 'day'){
                    ++day_counter;
                }
            }
        }else{
            for(var i=0;i<pages_length;++i){
                if((diary_pages[i].page_url == image_front || diary_pages[i].page_url == image_back)&& diary_pages[i].page_type == 'month'){
                    continue;
                }else{
                    if(diary_pages[i].page_type != "blank"){
                        updated_pages.push(diary_pages[i]);
                    }
                }
            
            }
        }
        diary_pages = updated_pages;
        renderPages();
    }

    function backCoverPages(element){
        let image_front = element.closest(".page_item").querySelector(".extra-image").getAttribute("src");
        let image_back = element.closest(".page_item").querySelector(".preview-icon").getAttribute("data-backimage");
        let pages_length = diary_pages.length;
        let updated_pages = [];

        if(element.checked){
            if(diary_pages[pages_length-2].page_type == "blank"){
                diary_pages[pages_length-2] = {page_type:"inner_cover_back", page_url: image_front };
                if(image_back){
                    diary_pages[pages_length-2] = {page_type:"inner_cover_back", page_url: image_back };
                }
            }else{
                diary_pages.splice(diary_pages.length-1, 0, {page_type:"inner_cover_back", page_url: image_front });
                if(image_back){
                    diary_pages.splice(diary_pages.length-1, 0, {page_type:"inner_cover_back", page_url: image_back });
                }
            }
        }else{
            for(var i=0;i<pages_length;++i){
                if((diary_pages[i].page_url == image_front || diary_pages[i].page_url == image_back)&& diary_pages[i].page_type == 'inner_cover_back'){
                    continue;
                }else{
                    if(diary_pages[i].page_type != "blank"){
                        updated_pages.push(diary_pages[i]);
                    }
                }
            
            }
            diary_pages = updated_pages;
        }
        
        
        renderPages();
    }

</script>
